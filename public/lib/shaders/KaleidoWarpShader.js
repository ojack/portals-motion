/**
 * @author Olivia Jack @rhizomaticode
 *
 * Kaleidoscope Warp Shader
 * Radial reflection around center point
 * with extra warp defined by "offset"
 *
 * based off of Kaleidoscope Shader by Felix Turner
 * Ported from: http://pixelshaders.com/editor/
 * by Toby Schachman / http://tobyschachman.com/
 *
 * sides: number of reflections
 * angle: initial angle in radians
 */

THREE.KaleidoWarpShader = {

	uniforms: {

		"tDiffuse": { type: "t", value: null },
		"sides":    { type: "f", value: 6.0 },
		"angle":    { type: "f", value: 0.0 },
		"offset":    { type: "f", value: 10.0 },

	},

	vertexShader: [

		"varying vec2 vUv;",

		"void main() {",

			"vUv = uv;",
			"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",

		"}"

	].join("\n"),

	fragmentShader: [

		"uniform sampler2D tDiffuse;",
		"uniform float sides;",
		"uniform float angle;",
		"uniform float offset;",
		
		"varying vec2 vUv;",

		"void main() {",

			"vec2 p = vUv - 0.5;", // vector from center to texture coordinate
			/* convert to polar coordinates */
			"float r = length(p);", //radius
			"float a = atan(p.x, p.y);", // angle
			"float tau = 2. * 3.1416 ;", //pi
			"a = mod(a, tau/sides) + (a/(tau/sides))*offset;",
			"a = abs(a - tau/sides/2.) ;",
			"p = r * vec2(cos(a), sin(a));",
			"vec4 color = texture2D(tDiffuse, p + 0.5);",
			"gl_FragColor = color;",

		"}"

	].join("\n")

};
